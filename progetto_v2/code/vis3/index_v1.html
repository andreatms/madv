<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InfoVis Project</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      header {
        background-color: #3498db;
        padding: 1rem;
        color: white;
      }

      .header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .header h1 {
        color: #2c3e50;
        margin-bottom: 1rem;
      }

      .header p {
        color: #7f8c8d;
        font-size: 1.1rem;
      }

      .back-button {
        position: absolute;
        bottom: 25px;
        left: 25px;
        padding: 8px 15px;
        background-color: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-size: 14px;
        z-index: 1000;
        transition: background-color 0.2s;
      }

      .back-button:hover {
        background-color: #2980b9;
      }

      svg {
        background-color: #f5f5f5;
        display: block;
        margin: auto;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Visualizzazione 3</h1>
    </header>

    <footer>
      <a href="../index.html" class="back-button">‚Üê Back to Dashboard</a>
    </footer>

    <div class="container"></div>

    <script>
      function drawGraph(data) {
        const width = 800,
          height = 600;

        const svg = d3
          .select(".container")
          .append("svg")
          .attr("class", "graph")
          .attr("width", width)
          .attr("height", height);

        const simulation = d3
          .forceSimulation(data.nodes)
          .force(
            "link",
            d3.forceLink(data.links).id((d) => d.id)
          )
          .force("charge", d3.forceManyBody())
          .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg
          .append("g")
          .selectAll("line")
          .data(data.links)
          .enter()
          .append("line")
          .attr("stroke", "#999")
          .attr("stroke-width", 1);

        const node = svg
          .append("g")
          .selectAll("circle")
          .data(data.nodes)
          .enter()
          .append("circle")
          .attr("r", (d) => (d.type === "meal" ? 8 : 4))
          .attr("fill", (d) => (d.type === "meal" ? "red" : "blue"))
          .call(
            d3
              .drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended)
          );

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
        });

        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }

        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }
      }

      Promise.all([
        d3.json("../../data/ingredients.json"),
        d3.json("../../data/meals_corrected.json"),
      ])
        .then(([ingredients, meals]) => {
          const nodes = [
            ...ingredients.map((ing) => ({ id: ing, type: "ingredient" })),
          ];
          const mealNodes = Object.keys(meals).map((meal) => ({
            id: meal,
            type: "meal",
          }));
          nodes.push(...mealNodes);

          const links = [];
          Object.entries(meals).forEach(([meal, details]) => {
            details.ingredients.forEach((ingredient) => {
              if (ingredients.includes(ingredient)) {
                links.push({ source: ingredient, target: meal });
              }
            });
          });

          drawGraph({ nodes, links });
        })
        .catch((error) => {
          console.error("Error loading the datasets:", error);
        });
    </script>
  </body>
</html>
